<div class="calendar-container">
  <header class="calendar-header">
    <button class="nav-btn" (click)="previousMonth()">
      <span>‹</span>
    </button>
    <h2 class="title">{{ 'MONTHS.' + monthNames[currentMonth] | translate }} {{ currentYear }}</h2>
    <button class="nav-btn" (click)="nextMonth()">
      <span>›</span>
    </button>
  </header>

  <div class="view-toggle">
    <button 
      class="toggle-btn" 
      [class.active]="viewMode === 'monthly'"
      (click)="viewMode !== 'monthly' && toggleView()">
      {{ 'CALENDAR.MONTHLY' | translate }}
    </button>
    <button 
      class="toggle-btn" 
      [class.active]="viewMode === 'yearly'"
      (click)="viewMode !== 'yearly' && toggleView()">
      {{ 'CALENDAR.YEARLY' | translate }}
    </button>
  </div>

  <!-- Monthly View -->
  <div class="monthly-view" *ngIf="viewMode === 'monthly'">
    <div class="weekdays">
      <div class="weekday" *ngFor="let day of weekDays">{{ 'WEEKDAYS.' + day | translate }}</div>
    </div>
    <div class="days-grid">
      <div 
        class="day-cell"
        *ngFor="let day of days"
        [class.other-month]="!day.isCurrentMonth"
        [class.today]="day.isToday"
        [class.attended]="day.attended"
        (click)="onDayClick(day)">
        <span class="day-number">{{ day.date }}</span>
        <span class="workout-icon" *ngIf="day.attended && getWorkoutIcon(day.fullDate)">
          {{ getWorkoutIcon(day.fullDate) }}
        </span>
        <span class="attendance-dot" *ngIf="day.attended && !getWorkoutIcon(day.fullDate)"></span>
      </div>
    </div>
  </div>

  <!-- Yearly View -->
  <div class="yearly-view" *ngIf="viewMode === 'yearly'">
    <div class="month-card" *ngFor="let monthData of monthsData">
      <h3 class="month-name">{{ 'MONTHS.' + monthData.name | translate }}</h3>
      <div class="mini-weekdays">
        <span *ngFor="let day of weekDays">
           {{ 'WEEKDAYS_MINI.' + day | translate }}
        </span>
      </div>
      <div class="mini-days-grid">
        <div 
          class="mini-day"
          *ngFor="let day of monthData.days"
          [class.empty]="day.date === 0"
          [class.today]="day.isToday"
          [class.attended]="day.attended"
          [class.has-icon]="day.attended && getWorkoutIcon(day.fullDate)"
          (click)="day.date !== 0 && onDayClick(day)">
          <span *ngIf="day.date !== 0 && !(day.attended && getWorkoutIcon(day.fullDate))">{{ day.date }}</span>
          <span *ngIf="day.attended && getWorkoutIcon(day.fullDate)" class="mini-icon">{{ getWorkoutIcon(day.fullDate) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

<!-- Attendance Popup -->
<div class="popup-overlay" *ngIf="showPopup" (click)="closePopup()">
  <div class="popup" (click)="$event.stopPropagation()">
    <h3 *ngIf="selectedDate">
      {{ getDay(selectedDate.fullDate) }} 
      {{ 'MONTHS.' + getMonthKey(selectedDate.fullDate) | translate }} 
      {{ getYear(selectedDate.fullDate) }}
    </h3>
    
    <div *ngIf="selectedDate?.attended">
      <p>{{ 'CALENDAR.WENT_TO_GYM' | translate }}</p>
      
      <!-- View Mode -->
      <div class="workout-type-display" *ngIf="!isEditingType">
        <ng-container *ngIf="getWorkoutIcon(selectedDate!.fullDate)">
          <span class="type-icon">{{ getWorkoutIcon(selectedDate!.fullDate) }}</span>
          <span class="type-name">{{ getWorkoutTypeName(selectedDate!.fullDate) }}</span>
        </ng-container>
        <span class="no-type" *ngIf="!getWorkoutIcon(selectedDate!.fullDate)">{{ 'CALENDAR.NO_TYPE' | translate }}</span>
        <button class="edit-btn" (click)="startEditType()" *ngIf="workoutTypes.length > 0">✏️</button>
      </div>
      
      <!-- Edit Mode -->
      <div class="workout-type-editor" *ngIf="isEditingType">
        <label class="editor-label">{{ 'CALENDAR.SELECT_TYPE' | translate }}</label>
        <div class="custom-select" [class.open]="dropdownOpen">
          <div class="select-trigger" (click)="toggleDropdown()">
            <span *ngIf="getSelectedType()">
              {{ getSelectedType()!.icon }} {{ getSelectedType()!.name }}
            </span>
            <span *ngIf="!getSelectedType()">{{ 'CALENDAR.NO_TYPE_OPTION' | translate }}</span>
            <span class="chevron"></span>
          </div>
          <div class="options-container" *ngIf="dropdownOpen">
            <div class="option" (click)="selectType('')">
              <span class="option-name">{{ 'CALENDAR.NO_TYPE_OPTION' | translate }}</span>
            </div>
            <div class="option" *ngFor="let type of workoutTypes" (click)="selectType(type.id)">
              <span class="option-icon">{{ type.icon }}</span>
              <span class="option-name">{{ type.name }}</span>
            </div>
          </div>
        </div>
        
        <div class="edit-actions">
          <button class="btn-small btn-save" (click)="saveEditType()">{{ 'CALENDAR.SAVE' | translate }}</button>
          <button class="btn-small btn-cancel" (click)="cancelEditType()">{{ 'CALENDAR.CANCEL' | translate }}</button>
        </div>
      </div>
    </div>
    
    <div *ngIf="!selectedDate?.attended">
      <p>{{ 'CALENDAR.DID_YOU_GO' | translate }}</p>
      
      <!-- Workout Type Selector -->
      <div class="workout-type-selector" *ngIf="workoutTypes.length > 0">
        <label>{{ 'CALENDAR.SELECT_TYPE' | translate }} {{ 'CALENDAR.OPTIONAL' | translate }}</label>
        
        <div class="custom-select" [class.open]="dropdownOpen">
          <div class="select-trigger" (click)="toggleDropdown()">
            <span *ngIf="getSelectedType()">
              {{ getSelectedType()!.icon }} {{ getSelectedType()!.name }}
            </span>
            <span *ngIf="!getSelectedType()">{{ 'CALENDAR.SELECT_TYPE_OPTION' | translate }}</span>
            <span class="chevron"></span>
          </div>
          <div class="options-container" *ngIf="dropdownOpen">
            <div class="option" (click)="selectType('')">
              <span class="option-name">{{ 'CALENDAR.SELECT_TYPE_OPTION' | translate }}</span>
            </div>
            <div class="option" *ngFor="let type of workoutTypes" (click)="selectType(type.id)">
              <span class="option-icon">{{ type.icon }}</span>
              <span class="option-name">{{ type.name }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <p class="no-types-hint" *ngIf="workoutTypes.length === 0">
        <small>{{ 'CALENDAR.ADD_TYPES_HINT' | translate }}</small>
      </p>
    </div>
    
    <div class="popup-actions">
      <button 
        class="btn" 
        [class.btn-danger]="selectedDate?.attended"
        [class.btn-success]="!selectedDate?.attended"
        (click)="toggleAttendance()">
        {{ selectedDate?.attended ? ('CALENDAR.REMOVE' | translate) : ('CALENDAR.MARK_ATTENDED' | translate) }}
      </button>
      <button class="btn btn-secondary" (click)="closePopup()">{{ 'CALENDAR.CANCEL' | translate }}</button>
    </div>
  </div>
</div>
